<div class="space-y-6">
  <div>
    <%= link_to "‚Üê Voltar para o dashboard", dashboard_path, class: "text-sm font-semibold text-slate-700 hover:text-slate-900" %>
  </div>

  <div class="flex items-end justify-between gap-4">
    <div>
      <p class="text-sm font-semibold text-slate-600">Prova</p>
      <h1 class="mt-2 text-2xl font-bold tracking-tight text-slate-900"><%= @prova.titulo %></h1>
      <p class="mt-1 text-slate-600">Criada em <span class="font-semibold text-slate-900"><%= l(@prova.data_criacao) %></span></p>
      <% if @prova.aluno.present? %>
        <p class="mt-1 text-slate-600">
          Aluno: <span class="font-semibold text-slate-900"><%= @prova.aluno.ra %></span>
          <span class="text-slate-500">‚Äî</span>
          <span class="font-semibold text-slate-900"><%= @prova.aluno.nome %></span>
        </p>
        <% correction = ProvaCorrectionService.new(@prova) %>
        <% score = correction.calculate_score %>
        <% max_score = correction.calculate_max_score %>
        <% percentage = correction.calculate_percentage %>
        <% details = correction.get_details %>
        <% tem_pendentes = details.any? { |d| d[:avaliacao_ia] == "pendente" } %>
        <% if max_score > 0 %>
          <p class="mt-2 text-sm text-slate-600">
            Pontua√ß√£o: <span class="font-semibold text-slate-900"><%= score.round(2) %> / <%= max_score.round(2) %></span>
            <span class="text-slate-500">‚Äî</span>
            <span class="font-semibold <%= percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-rose-600' %>"><%= percentage %>%</span>
            <% if tem_pendentes %>
              <span class="ml-2 inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-semibold text-blue-700">‚è≥ Dissertativas pendentes de corre√ß√£o com IA</span>
            <% end %>
          </p>
        <% end %>
      <% end %>
    </div>
    <div class="flex gap-2">
      <%= link_to "Voltar", provas_path, class: "inline-flex items-center justify-center rounded-xl border border-slate-300/80 bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-2" %>
      <%= link_to "Editar", edit_prova_path(@prova), class: "inline-flex items-center justify-center rounded-xl border border-slate-300/80 bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-2" %>
      <% if @prova.questoes.joins(:gabarito).where(tipo: "dissertativa").exists? %>
        <%= button_to "ü§ñ Corrigir com IA", corrigir_ia_prova_path(@prova), method: :post, data: { turbo_confirm: "Isso vai enviar as quest√µes dissertativas para avalia√ß√£o com IA. Pode levar alguns segundos. Continuar?" }, class: "inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-violet-600 to-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm shadow-violet-200/60 transition hover:-translate-y-0.5 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-violet-400 focus:ring-offset-2" %>
      <% end %>
      <%= button_to "Excluir", prova_path(@prova), method: :delete, data: { turbo_confirm: "Tem certeza?" }, class: "inline-flex items-center justify-center rounded-xl border border-rose-200 bg-rose-50 px-4 py-2 text-sm font-semibold text-rose-800 shadow-sm transition hover:bg-rose-100 focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2" %>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
    <div class="rounded-2xl border border-slate-200/80 bg-white p-6 shadow-sm ring-1 ring-black/5">
      <p class="text-sm font-semibold text-slate-900">Quest√µes</p>
      <p class="mt-1 text-sm text-slate-600">Crie e edite as quest√µes desta prova.</p>
      <p class="mt-3 text-sm text-slate-600">
        Total: <span class="font-semibold text-slate-900"><%= @prova.questoes.size %></span>
      </p>

      <div class="mt-4 flex flex-wrap gap-2">
        <%= link_to "Ver quest√µes", prova_questoes_path(@prova), class: "inline-flex items-center justify-center rounded-xl border border-slate-300/80 bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-2" %>
        <%= link_to "Criar quest√£o", new_prova_questao_path(@prova), class: "inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-indigo-600 to-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm shadow-indigo-200/60 transition hover:-translate-y-0.5 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2" %>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-200/80 bg-white p-6 shadow-sm ring-1 ring-black/5">
      <p class="text-sm font-semibold text-slate-900">Gabarito</p>
      <p class="mt-1 text-sm text-slate-600">Defina as respostas corretas para a corre√ß√£o.</p>
      <p class="mt-3 text-sm text-slate-600">
        Itens: <span class="font-semibold text-slate-900"><%= @prova.gabaritos.size %></span>
      </p>

      <div class="mt-4 flex flex-wrap gap-2">
        <%= link_to "Preencher gabarito", prova_gabarito_path(@prova), class: "inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-indigo-600 to-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm shadow-indigo-200/60 transition hover:-translate-y-0.5 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2" %>
      </div>
    </div>
  </div>

  <% if defined?(details) && details&.any? %>
    <div class="rounded-2xl border border-slate-200/80 bg-white p-6 shadow-sm ring-1 ring-black/5">
      <div class="mb-4">
        <p class="text-lg font-semibold text-slate-900">üìù Corre√ß√£o detalhada</p>
        <p class="mt-1 text-sm text-slate-600">Resultado de cada quest√£o com avalia√ß√£o autom√°tica.</p>
      </div>

      <div class="space-y-4">
        <% @prova.questoes.joins(:gabarito).each_with_index do |questao, idx| %>
          <% detail = details.find { |d| d[:questao_id] == questao.id } %>
          <% next unless detail %>
          <% is_pendente = detail[:avaliacao_ia] == 'pendente' %>
          <% border_class = if is_pendente
                              'border-blue-200 bg-blue-50/50'
                            elsif detail[:correta]
                              'border-green-200 bg-green-50/50'
                            elsif detail[:avaliacao_ia] == 'parcial'
                              'border-yellow-200 bg-yellow-50/50'
                            else
                              'border-rose-200 bg-rose-50/50'
                            end %>
          <% badge_class = if is_pendente
                             'bg-blue-100 text-blue-800'
                           elsif detail[:correta]
                             'bg-green-100 text-green-800'
                           elsif detail[:avaliacao_ia] == 'parcial'
                             'bg-yellow-100 text-yellow-800'
                           else
                             'bg-rose-100 text-rose-800'
                           end %>
          <% badge_text = if is_pendente
                            '‚è≥ Pendente'
                          elsif detail[:correta]
                            '‚úÖ Correta'
                          elsif detail[:avaliacao_ia] == 'parcial'
                            '‚ö†Ô∏è Parcial'
                          else
                            '‚ùå Incorreta'
                          end %>
          <div class="rounded-xl border p-4 <%= border_class %>">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <p class="text-sm font-semibold text-slate-900">Quest√£o <%= idx + 1 %></p>
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold <%= badge_class %>">
                    <%= badge_text %>
                  </span>
                  <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600">
                    <%= questao.tipo_dissertativa? ? 'üìù Dissertativa' : 'üîò M√∫ltipla escolha' %>
                  </span>
                </div>
                <p class="mt-2 text-sm text-slate-700"><%= questao.enunciado %></p>

                <div class="mt-3 grid grid-cols-1 gap-2 sm:grid-cols-2">
                  <div class="rounded-lg bg-white/80 p-2 ring-1 ring-slate-200/60">
                    <p class="text-xs font-semibold text-slate-500">Resposta do aluno</p>
                    <p class="mt-1 text-sm text-slate-800"><%= detail[:resposta_colocada] %></p>
                  </div>
                  <div class="rounded-lg bg-white/80 p-2 ring-1 ring-slate-200/60">
                    <p class="text-xs font-semibold text-slate-500">Gabarito</p>
                    <p class="mt-1 text-sm text-slate-800"><%= detail[:resposta_correta] %></p>
                  </div>
                </div>

                <% if detail[:avaliacao_ia].present? %>
                  <div class="mt-2 rounded-lg bg-indigo-50/80 p-2 ring-1 ring-indigo-200/60">
                    <p class="text-xs font-semibold text-indigo-600">ü§ñ Avalia√ß√£o da IA</p>
                    <p class="mt-1 text-sm text-indigo-800"><%= detail[:justificativa_ia] %></p>
                  </div>
                <% end %>
              </div>
              <div class="text-right">
                <% if is_pendente %>
                  <p class="text-lg font-bold text-blue-500">‚Äî</p>
                <% else %>
                  <p class="text-lg font-bold <%= detail[:pontos] > 0 ? 'text-green-700' : 'text-rose-600' %>">
                    <%= detail[:pontos].to_f.round(2) %>
                  </p>
                <% end %>
                <p class="text-xs text-slate-500">de <%= detail[:peso] %></p>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
