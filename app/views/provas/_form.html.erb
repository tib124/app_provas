<div class="rounded-3xl border border-slate-200/80 bg-white/80 p-6 shadow-lg shadow-slate-200/60 ring-1 ring-black/5 backdrop-blur">
  <%= form_with model: prova, class: "space-y-6" do |f| %>
    <% if prova.errors.any? %>
      <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-900 ring-1 ring-rose-100">
        <p class="font-semibold">Verifique os campos:</p>
        <ul class="mt-2 list-disc pl-5">
          <% prova.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
      <div>
        <%= f.label :titulo, "Título", class: "block text-sm font-semibold text-slate-900" %>
        <%= f.text_field :titulo, autofocus: true, class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200" %>
      </div>

      <div>
        <%= f.label :data_criacao, "Data de criação", class: "block text-sm font-semibold text-slate-900" %>
        <%= f.date_field :data_criacao, class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200" %>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-200/80 bg-white p-5 ring-1 ring-black/5">
      <div class="flex items-end justify-between gap-4">
        <div>
          <%= f.label :aluno_ra, "Aluno (RA)", class: "block text-sm font-semibold text-slate-900" %>
          <p class="mt-1 text-sm text-slate-600">Selecione o aluno para ligar esta prova ao RA.</p>
        </div>
        <%= link_to "Cadastrar aluno", new_aluno_path, class: "inline-flex items-center justify-center rounded-xl border border-slate-300/80 bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-2" %>
      </div>

      <%= f.collection_select :aluno_ra,
                              (@alunos || []),
                              :ra,
                              :display_name,
                              { include_blank: "Selecione um aluno…" },
                              class: "mt-3 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200" %>
    </div>

    <div class="rounded-2xl border border-slate-200/80 bg-white p-5 ring-1 ring-black/5" data-controller="nested-questions">
      <div class="flex items-end justify-between gap-4">
        <div>
          <p class="text-sm font-semibold text-slate-900">Questões</p>
          <p class="mt-1 text-sm text-slate-600">Adicione enunciado e tipo (Múltipla escolha ou Dissertativa).</p>
        </div>

        <button type="button" data-action="nested-questions#add" class="inline-flex items-center justify-center rounded-xl border border-slate-300/80 bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-2">
          Adicionar questão
        </button>
      </div>

      <div class="mt-4 space-y-4" data-nested-questions-target="container">
        <%= f.fields_for :questoes do |qf| %>
          <div class="rounded-2xl border border-slate-200/80 bg-slate-50/60 p-4" data-nested-questions-question data-controller="questao-fields">
            <%= qf.hidden_field :_destroy, value: 0, data: { nested_questions_target: "destroy" } %>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
              <div class="md:col-span-2">
                <%= qf.label :tipo, "Tipo", class: "block text-sm font-semibold text-slate-900" %>
                <%= qf.select :tipo,
                  [["Múltipla escolha", "multipla_escolha"], ["Dissertativa", "dissertativa"]],
                  {},
                  class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200",
                  data: { questao_fields_target: "tipo", action: "change->questao-fields#toggle" } %>
              </div>

              <div>
                <%= qf.label :peso, "Peso", class: "block text-sm font-semibold text-slate-900" %>
                <%= qf.number_field :peso, step: 0.1, min: 1, max: 10, lang: "pt-BR", class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200" %>
                <p class="mt-1 text-xs text-slate-500">De 1 a 10 (ex.: 1.2)</p>
              </div>
            </div>

            <div class="mt-4">
              <%= qf.label :enunciado, "Enunciado", class: "block text-sm font-semibold text-slate-900" %>
              <%= qf.text_area :enunciado, rows: 4, class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200" %>
            </div>

            <div class="mt-4" data-questao-fields-target="respostasWrapper">
              <%= qf.label :respostas, "Respostas (alternativas)", class: "block text-sm font-semibold text-slate-900" %>
              <%= qf.text_area :respostas,
                               rows: 4,
                               placeholder: "A-) ...\nB-) ...",
                               class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200",
                               data: { questao_fields_target: "respostas", action: "input->questao-fields#syncSelectOptions" } %>
              <p class="mt-1 text-xs text-slate-500">Somente para múltipla escolha.</p>
            </div>

            <div class="mt-4" data-questao-fields-target="respostaSelectWrapper">
              <%= qf.label :resposta_colocada, "Resposta escolhida", class: "block text-sm font-semibold text-slate-900" %>
              <%= qf.select :resposta_colocada,
                            qf.object.respond_to?(:alternativa_labels) ? qf.object.alternativa_labels : [],
                            { include_blank: "Selecione…" },
                            class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200",
                            data: { questao_fields_target: "respostaSelect" } %>
            </div>

            <div class="mt-4" data-questao-fields-target="respostaTextWrapper">
              <%= qf.label :resposta_colocada, "Resposta escolhida", class: "block text-sm font-semibold text-slate-900" %>
              <%= qf.text_area :resposta_colocada,
                               rows: 4,
                               class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200",
                               data: { questao_fields_target: "respostaText" } %>
            </div>

            <div class="mt-4 flex justify-end">
              <button type="button" data-action="nested-questions#remove" class="inline-flex items-center justify-center rounded-xl border border-rose-200 bg-rose-50 px-4 py-2 text-sm font-semibold text-rose-800 shadow-sm transition hover:bg-rose-100 focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2">
                Remover
              </button>
            </div>
          </div>
        <% end %>
      </div>

      <template data-nested-questions-target="template">
        <%= f.fields_for :questoes, Questao.new, child_index: "NEW_RECORD" do |qf| %>
          <div class="rounded-2xl border border-slate-200/80 bg-slate-50/60 p-4" data-nested-questions-question data-controller="questao-fields">
            <%= qf.hidden_field :_destroy, value: 0, data: { nested_questions_target: "destroy" } %>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
              <div class="md:col-span-2">
                <%= qf.label :tipo, "Tipo", class: "block text-sm font-semibold text-slate-900" %>
                <%= qf.select :tipo,
                  [["Múltipla escolha", "multipla_escolha"], ["Dissertativa", "dissertativa"]],
                  {},
                  class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200",
                  data: { questao_fields_target: "tipo", action: "change->questao-fields#toggle" } %>
              </div>

              <div>
                <%= qf.label :peso, "Peso", class: "block text-sm font-semibold text-slate-900" %>
                <%= qf.number_field :peso, value: 1.0, step: 0.1, min: 1, max: 10, lang: "pt-BR", class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200" %>
                <p class="mt-1 text-xs text-slate-500">De 1 a 10 (ex.: 1.2)</p>
              </div>
            </div>

            <div class="mt-4">
              <%= qf.label :enunciado, "Enunciado", class: "block text-sm font-semibold text-slate-900" %>
              <%= qf.text_area :enunciado, rows: 4, class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200" %>
            </div>

            <div class="mt-4" data-questao-fields-target="respostasWrapper">
              <%= qf.label :respostas, "Respostas (alternativas)", class: "block text-sm font-semibold text-slate-900" %>
              <%= qf.text_area :respostas,
                               rows: 4,
                               placeholder: "A-) ...\nB-) ...",
                               class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200",
                               data: { questao_fields_target: "respostas", action: "input->questao-fields#syncSelectOptions" } %>
              <p class="mt-1 text-xs text-slate-500">Somente para múltipla escolha.</p>
            </div>

            <div class="mt-4" data-questao-fields-target="respostaSelectWrapper">
              <%= qf.label :resposta_colocada, "Resposta escolhida", class: "block text-sm font-semibold text-slate-900" %>
              <%= qf.select :resposta_colocada,
                            [],
                            { include_blank: "Selecione…" },
                            class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200",
                            data: { questao_fields_target: "respostaSelect" } %>
            </div>

            <div class="mt-4" data-questao-fields-target="respostaTextWrapper">
              <%= qf.label :resposta_colocada, "Resposta escolhida", class: "block text-sm font-semibold text-slate-900" %>
              <%= qf.text_area :resposta_colocada,
                               rows: 4,
                               class: "mt-2 w-full rounded-xl border border-slate-300/80 bg-white/80 px-3 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200",
                               data: { questao_fields_target: "respostaText" } %>
            </div>

            <div class="mt-4 flex justify-end">
              <button type="button" data-action="nested-questions#remove" class="inline-flex items-center justify-center rounded-xl border border-rose-200 bg-rose-50 px-4 py-2 text-sm font-semibold text-rose-800 shadow-sm transition hover:bg-rose-100 focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2">
                Remover
              </button>
            </div>
          </div>
        <% end %>
      </template>
    </div>

    <div class="pt-2 flex gap-3">
      <%= f.submit (prova.persisted? ? "Salvar alterações" : "Criar prova"), class: "inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-indigo-600 to-sky-600 px-5 py-3 text-sm font-semibold text-white shadow-sm shadow-indigo-200/60 transition hover:-translate-y-0.5 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2" %>
      <%= link_to "Cancelar", (prova.persisted? ? prova_path(prova) : provas_path), class: "inline-flex items-center justify-center rounded-xl border border-slate-300/80 bg-white px-5 py-3 text-sm font-semibold text-slate-900 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-2" %>
    </div>
  <% end %>
</div>
